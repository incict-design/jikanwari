<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>授業交換候補表示（並べ替え対応）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h1 { font-size: 1.2rem; }
    label { display:block; margin-top:1rem; }
    select,input { padding:4px; }
    table { border-collapse:collapse; margin-top:1rem; width:100%; max-width:1200px; }
    th,td { border:1px solid #ccc; padding:6px 8px; font-size:0.9rem; text-align:left; }
    .muted { color:#777; font-size:0.85rem; }
    .training-conflict { color: red; font-weight: 700; }
    .parttime-row { color: blue; font-weight: 700; }
    .warn { color:#b35; }
  </style>
</head>
<body>
  <h1>授業交換候補表示（並べ替え対応）</h1>
  <p class="muted">
    授業CSV: <code>teacher,grade,class,course,day,period,subject,group</code>／研修CSV: <code>teacher,day,slot,detail,parttime</code><br>
    表示順: <strong>何もなし → 合同授業 → 研修 → 非常勤</strong>（赤＞青の色優先は維持）
  </p>

  <label>授業CSVを読み込む: <input type="file" id="fileLessons" accept=".csv" /></label>
  <label>研修CSVを読み込む（任意）: <input type="file" id="fileTrainings" accept=".csv" /></label>

  <label>教員:
    <select id="teacherSelect" disabled>
      <option value="">先に授業CSVを読み込んでください</option>
    </select>
  </label>

  <label>授業（コマ）:
    <select id="lessonSelect" disabled>
      <option value="">先に教員を選んでください</option>
    </select>
  </label>

  <div id="results" class="muted" style="margin-top:1.2rem;">まだ選択されていません。</div>

  <script>
    const CLASS_LIMITS = { 1: 9, 2: 8, 3: 9 };
    const DAY_MAP_IN = {
      "mon":"Mon","monday":"Mon","月":"Mon",
      "tue":"Tue","tuesday":"Tue","火":"Tue",
      "wed":"Wed","wednesday":"Wed","水":"Wed",
      "thu":"Thu","thursday":"Thu","木":"Thu",
      "fri":"Fri","friday":"Fri","金":"Fri",
      "sat":"Sat","saturday":"Sat","土":"Sat"
    };
    const DAY_JA_OUT = {Mon:"月", Tue:"火", Wed:"水", Thu:"木", Fri:"金", Sat:"土"};
    const ORD = {1:"1st",2:"2nd",3:"3rd",4:"4th",5:"5th",6:"6th",7:"7th"};

    let lessons = [];
    let trainings = [];
    let trainingTeachers = new Set();
    let teacherParttimeMap = new Map();

    const fileLessons = document.getElementById('fileLessons');
    const fileTrainings = document.getElementById('fileTrainings');
    const teacherSelect = document.getElementById('teacherSelect');
    const lessonSelect = document.getElementById('lessonSelect');
    const resultsDiv = document.getElementById('results');

    // ------------- ユーティリティ -------------
    function parseCSV(text){ return text.replace(/^\uFEFF/, '').trim().split(/\r?\n/).map(l=>l.split(',').map(s=>s.trim())); }
    function normalizeDay(d){ if(!d) return ""; const k=String(d).toLowerCase(); return DAY_MAP_IN[k]||d; }
    function parseDigit(s){ if(s==null) return NaN; const m=String(s).match(/\d+/); return m?parseInt(m[0],10):NaN; }
    function parseGrade(g){ const n=parseDigit(g); return [1,2,3].includes(n)?n:NaN; }
    function parseClass(c){ return parseDigit(c); }
    function parsePeriod(p){ const n=parseDigit(p); return (n>=1&&n<=7)?n:NaN; }
    function normalizeCourse(c){ if(!c) return ""; const low=String(c).trim().toLowerCase(); if(["文系","humanities","arts","h"].includes(low))return"文系"; if(["理系","science","sci","s"].includes(low))return"理系"; return String(c).trim(); }
    function periodToSlot(period){ return period<=4?"am":"pm"; }
    function teacherHasSlot(teacher,day,period){ return lessons.some(l=>l.teacher===teacher&&l.day===day&&l.period===period); }
    function sameClassAndCourse(a,b){ if(a.grade!==b.grade) return false; if(a.class!==b.class) return false; if(a.grade>=2&&(a.course||"")!==(b.course||"")) return false; return true; }
    function formatSlot(day,period){ const d=DAY_JA_OUT[day]||day; const p=ORD[period]||(period+"限"); return d+p; }
    function findTraining(teacher,day,slot){ return trainings.find(t=>t.teacher===teacher&&t.day===day&&t.slot===slot); }
    function isParttimeTeacher(teacher){ if(!trainingTeachers.has(teacher)) return true; return !!teacherParttimeMap.get(teacher); }

    // 並べ替え用ランク: 非常勤(0) < 研修(1) < 合同(2) < 何もなし(3)
    function rankCandidate(c){
      const isJoint = !!(c.other.group);        // 相手の授業が合同なら優先度「合同」
      if (!c.trainingOverlap && !c.parttime && !isJoint) return 3; // 何もなし
      if (isJoint && !c.trainingOverlap && !c.parttime) return 2;  // 合同のみ
      if (c.trainingOverlap && !c.parttime) return 1;              // 研修あり
      // それ以外は非常勤（非常勤かつ研修/合同の混在も最下位扱い）
      return 0;
    }

    // ------------- 授業CSV -------------
    function loadLessons(file){
      const reader=new FileReader();
      reader.onload=evt=>{
        const data=parseCSV(evt.target.result);
        if(data.length<2){ resultsDiv.textContent="授業CSVが空です"; enableTeacherSelect([]); return; }
        const h=data[0].map(x=>x.toLowerCase());
        const iT=h.indexOf('teacher'), iG=h.indexOf('grade'), iC=h.indexOf('class'),
              iCourse=h.indexOf('course'), iD=h.indexOf('day'), iP=h.indexOf('period'),
              iS=h.indexOf('subject'), iGrp=h.indexOf('group');
        if([iT,iG,iC,iD,iP,iS].some(i=>i<0)){ resultsDiv.innerHTML='<span class="warn">授業CSVの列名が不正です</span>'; enableTeacherSelect([]); return; }

        lessons = data.slice(1).map(r=>({
          teacher:r[iT],
          grade:parseGrade(r[iG]),
          class:parseClass(r[iC]),
          course:normalizeCourse(r[iCourse]),
          day:normalizeDay(r[iD]),
          period:parsePeriod(r[iP]),
          subject:r[iS],
          group:(iGrp>=0?(r[iGrp]||""):"")
        })).filter(l=>
          l.teacher&&[1,2,3].includes(l.grade)&&CLASS_LIMITS[l.grade]&&l.class>=1&&l.class<=CLASS_LIMITS[l.grade]&&
          ["Mon","Tue","Wed","Thu","Fri","Sat"].includes(l.day)&&!Number.isNaN(l.period)
        );

        enableTeacherSelect([...new Set(lessons.map(l=>l.teacher))].filter(Boolean));
        resultsDiv.textContent = lessons.length? "教員と授業を選ぶと交換候補を表示します。" : "有効な行がありません。";
      };
      reader.readAsText(file,'UTF-8');
    }

    function enableTeacherSelect(list){
      teacherSelect.innerHTML='<option value="">教員を選択</option>';
      list.forEach(t=>{ const op=document.createElement('option'); op.value=t; op.textContent=t; teacherSelect.appendChild(op); });
      teacherSelect.disabled=false;
      lessonSelect.disabled=true;
      lessonSelect.innerHTML='<option value="">先に教員を選んでください</option>';
    }

    // ------------- 研修CSV -------------
    function loadTrainings(file){
      const reader=new FileReader();
      reader.onload=evt=>{
        const data=parseCSV(evt.target.result);
        if(data.length<2){ trainings=[]; trainingTeachers=new Set(); teacherParttimeMap=new Map(); return; }
        const h=data[0].map(x=>x.toLowerCase());
        const iT=h.indexOf('teacher'), iD=h.indexOf('day'), iSlot=h.indexOf('slot'), iDetail=h.indexOf('detail'), iPart=h.indexOf('parttime');
        if(iT<0||iD<0||iSlot<0){ trainings=[]; trainingTeachers=new Set(); teacherParttimeMap=new Map(); return; }

        trainings = data.slice(1).map(r=>({
          teacher:r[iT],
          day:normalizeDay(r[iD]),
          slot:(r[iSlot]||"").toLowerCase(),
          detail:iDetail>=0?r[iDetail]:"",
          parttime:iPart>=0?(String(r[iPart]).toLowerCase()==="yes"):false
        })).filter(t=>t.teacher&&["Mon","Tue","Wed","Thu","Fri","Sat"].includes(t.day)&&(t.slot==="am"||t.slot==="pm"));

        trainingTeachers=new Set(trainings.map(t=>t.teacher));
        teacherParttimeMap=new Map();
        trainings.forEach(t=>{ teacherParttimeMap.set(t.teacher,(teacherParttimeMap.get(t.teacher)||false)||t.parttime); });
      };
      reader.readAsText(file,'UTF-8');
    }

    // ------------- イベント -------------
    fileLessons.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) loadLessons(f); });
    fileTrainings.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) loadTrainings(f); });

    teacherSelect.addEventListener('change',e=>{
      const name=e.target.value;
      if(!name){ lessonSelect.disabled=true; return; }
      const myLessons=lessons.filter(l=>l.teacher===name);
      lessonSelect.innerHTML='<option value="">授業を選択</option>';
      myLessons.forEach(l=>{
        const op=document.createElement('option');
        op.value=lessons.indexOf(l);
        const slot=formatSlot(l.day,l.period);
        const cText=l.grade>=2?` ${l.course||"(コース未指定)"}`:"";
        op.textContent=`${slot} ${l.grade}年${l.class}組${cText} ${l.subject}${l.group?' [合同:'+l.group+']':''}`;
        lessonSelect.appendChild(op);
      });
      lessonSelect.disabled=false;
      resultsDiv.textContent="交換したい授業を選択してください。";
    });

    lessonSelect.addEventListener('change',e=>{
      const idx=Number(e.target.value);
      if(Number.isNaN(idx)){ resultsDiv.textContent="授業を選んでください。"; return; }
      const me=lessons[idx];
      const myDay=me.day, myPeriod=me.period, mySlot=periodToSlot(myPeriod);

      // 候補生成
      let candidates = [];
      lessons.forEach(other=>{
        if(other.teacher===me.teacher) return;
        if(!sameClassAndCourse(me,other)) return;
        if(teacherHasSlot(me.teacher,other.day,other.period)) return;
        if(teacherHasSlot(other.teacher,myDay,myPeriod)) return;

        const trainingInfo = findTraining(other.teacher,myDay,mySlot);
        const trainingOverlap = !!trainingInfo;
        const parttimeFlag = isParttimeTeacher(other.teacher);

        candidates.push({ other, trainingOverlap, parttime: parttimeFlag });
      });

      if(!candidates.length){ resultsDiv.innerHTML="<p>交換できる候補はありません。</p>"; return; }

      // 並べ替え（高優先=上位表示）
      candidates.sort((a,b)=> rankCandidate(b) - rankCandidate(a));

      // 表描画
      const tbl=document.createElement('table');
      tbl.innerHTML="<thead><tr><th>相手教員</th><th>相手の授業</th><th>あなたの授業</th><th>相手の研修日</th><th>非常勤講師</th></tr></thead>";
      const tb=document.createElement('tbody');

      candidates.forEach(c=>{
        const o=c.other;
        const otherSlot=formatSlot(o.day,o.period);
        const mySlotDisp=formatSlot(myDay,myPeriod);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${o.teacher}</td>
          <td>${otherSlot} ${o.grade}年${o.class}組 ${o.subject}${o.group?' [合同:'+o.group+']':''}</td>
          <td>${mySlotDisp} ${me.grade}年${me.class}組 ${me.subject}${me.group?' [合同:'+me.group+']':''}</td>
          <td style="text-align:center;">${c.trainingOverlap?"〇":""}</td>
          <td style="text-align:center;">${c.parttime?"〇":""}</td>`;
        if(c.trainingOverlap) tr.classList.add("training-conflict");
        else if(c.parttime)   tr.classList.add("parttime-row");
        tb.appendChild(tr);
      });

      tbl.appendChild(tb);
      resultsDiv.innerHTML=""; resultsDiv.appendChild(tbl);
    });
  </script>
</body>
</html>

